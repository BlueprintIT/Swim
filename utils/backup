#! /bin/sh

BACKUPS=../backups/
cd ~/public_html

if [ "$1" ]; then
	BASE=$1
else
	BASE=`date +backup-%Y%m%d-%H%M`
fi

TEMP_FILE=$BACKUPS$BASE.tar
TARGET=$BACKUPS$BASE.tar.gz

rm -f $TARGET
rm -f $TEMP_FILE

find containers/user \( -name temp -o -name .svn -o -name dir.lock \) -prune -o -print | tar -cf $TEMP_FILE --exclude=.htaccess --no-recursion -T -
tar -rf $TEMP_FILE --ignore-failed-read bootstrap/host.conf >/dev/null 2>/dev/null
tar -rf $TEMP_FILE --ignore-failed-read --exclude=.htaccess conf

find onlinestore/language -name home.inc.php | tar -rf $TEMP_FILE --exclude=.htaccess --no-recursion -T -
tar -rf $TEMP_FILE --ignore-failed-read --exclude=.htaccess onlinestore/includes/global.inc.php onlinestore/images/uploads

mysqldump -a -c --add-drop-table -u${USER}_swim -pswim361 ${USER}_cubecart >database.sql
tar -rf $TEMP_FILE database.sql
rm -f database.sql

gzip $TEMP_FILE

utils/purge.pl $BACKUPS
